# チャット入力欄機能 仕様書

## 1. 概要

### 1.1 目的

wtermに、ページ下部にチャット入力欄（テキストエリア）を追加し、以下の機能を実現する：

1. **ショートカット送信**: Ctrl+1〜9のキーボードショートカットで、各セッションに素早くテキストを送信
2. **バッファ取得**: 各セッションのターミナル出力を取得し、編集してから別のセッションに転送
3. **柔軟な送信方法**: 現在のセッション、特定のセッション、全セッションへの送信をサポート

### 1.2 対象ユーザー

AIエージェント開発者（Claude Code、GitHub Copilot CLI、Codexなど）を使用するwtermユーザー

### 1.3 背景

現状、セッション間でデータをやり取りするには、各セッションのターミナルに直接入力するか、`wterm-send`コマンドを使用する必要がある。この機能により、以下のユースケースが実現される：

- **AIエージェント間の協調作業**: 特定のセッション（例：Claude Code）でコマンドを実行し、その出力を別のセッション（例：GitHub Copilot CLI）に転送して分析させる
- **一括操作**: 同じコマンドやテキストを複数のセッションに一度に送信
- **クイックアクセス**: キーボードショートカットで特定のセッションに素早くメッセージを送信

## 2. 機能仕様

### 2.1 機能概要

```
┌─────────────────────────────────────────────────┐
│  ターミナル表示エリア                           │
│  (既存のxterm.jsセッション表示)                 │
│                                                 │
│                                                 │
└─────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────┐
│  ツールバー                                     │
│  [1][2][3][4][5][6][7][8][9]    [送信][全送信][×]│
│   ↑バッファ取得ボタン            ↑アクション   │
├─────────────────────────────────────────────────┤
│  テキストエリア                                 │
│  メッセージを入力...                            │
│  (高さ: 内容に応じて自動調整, 最大30%)          │
└─────────────────────────────────────────────────┘
```

### 2.2 画面構成

#### 2.2.1 全体レイアウト

- **配置**: ページ最下部に固定表示（常に表示）
- **構成要素**:
  1. ツールバー（上部）
  2. テキストエリア（下部）

#### 2.2.2 ツールバー

**左寄せ:**
- **バッファ取得ボタン**: セッション1〜9に対応する9個のボタン
  - ラベル: `1`, `2`, `3`, ..., `9`（セッション番号のみ）
  - 配置: 水平一列
  - スタイル: 小さめのボタン（例: 30x30px）

**右寄せ:**
- **送信ボタン（現在のセッション）**: 現在表示中のセッションに送信
  - ラベル: `送信` または `↑`
- **全セッション送信ボタン**: 全セッションにブロードキャスト
  - ラベル: `全送信` または `⇈`
- **クリアボタン**: テキストエリアの内容をクリア
  - ラベル: `×` または `クリア`

#### 2.2.3 テキストエリア

- **初期高さ**: 3行分（約80px）
- **最大高さ**: 画面の30%
- **高さ調整**: 内容に応じて自動的に拡張（最大高さまで）
- **プレースホルダー**: `メッセージを入力...`
- **フォント**: monospace（ターミナルと同じフォント）
- **スクロール**: 最大高さを超えた場合、縦スクロール表示

### 2.3 機能詳細

#### 2.3.1 テキスト送信機能

**送信方法:**

| 操作 | 動作 | 条件 |
|------|------|------|
| `Ctrl+1`〜`Ctrl+9` | セッション1〜9に送信 | テキストエリアにフォーカスがある時のみ |
| `Ctrl+Enter` | 現在表示中のセッションに送信 | テキストエリアにフォーカスがある時のみ |
| `Enter` | 改行を挿入 | - |
| 送信ボタンクリック | 現在表示中のセッションに送信 | - |
| 全送信ボタンクリック | 全セッションにブロードキャスト | - |

**送信時の動作:**
1. テキストエリアの内容を対象セッションのPTYに書き込む
2. 複数行のテキストの場合、改行を含めて全体を一度に送信
3. 送信完了後、テキストエリアの内容を自動的にクリア
4. 送信内容を入力履歴に追加

**エラーハンドリング:**
- 存在しないセッション番号へのショートカット送信（例: セッションが3つしかないのに`Ctrl+5`）→ 無視（何も起こらない）
- テキストエリアが空の状態での送信 → 無視（何も起こらない）

#### 2.3.2 バッファ取得機能

**基本動作:**

バッファ取得ボタン（1〜9）をクリックすると、対応するセッションのターミナル出力を取得し、テキストエリアに追加する。

**差分取得の仕組み:**

各セッションごとに「最後に取得した位置（インデックス）」を記録し、次回取得時はその位置以降の出力のみを取得する。

```typescript
// 各セッションの取得位置を管理
interface BufferPosition {
  [sessionId: string]: number; // 最後に取得したバッファのインデックス
}

// 例:
// 初回取得: session-1のバッファ全体（0〜1000文字）を取得 → position = 1000
// 2回目: session-1のバッファが1500文字に増えている → 1000〜1500文字（差分）を取得 → position = 1500
// 3回目: session-1のバッファが変化なし（1500文字のまま） → 何もしない
```

**取得時の動作フロー:**

1. ユーザーがバッファ取得ボタン（例: `3`）をクリック
2. サーバーに`session-3`のバッファ取得をリクエスト
3. サーバーが前回取得位置以降の差分を返す
4. 差分がある場合:
   - テキストエリアの末尾に差分を追加
   - 取得位置を更新
5. 差分がない場合:
   - 何もしない（サイレント）

**読み込み動作:**
- テキストエリアに既存の入力がある場合 → 末尾に追加
- テキストエリアが空の場合 → そのまま挿入

**通知:**
- バッファ取得時、ユーザーへの通知は表示しない（サイレント）
- エラー時のみトースト通知などで表示

**リセット機能:**
- 取得位置のリセット機能は提供しない
- 常に差分のみを取得し続ける

#### 2.3.3 入力履歴機能

**仕様:**
- 最大50件の送信履歴を保持
- 上下キーで過去の入力を呼び出し
- 履歴はブラウザのlocalStorageに保存（永続化）
- 全セッション共通の履歴（セッションごとには分けない）

**動作:**
1. テキストエリアにフォーカスがある状態で`↑`キーを押す → 1つ前の履歴を表示
2. `↓`キーを押す → 1つ後の履歴を表示（または現在の入力に戻る）
3. 履歴を表示中に編集可能
4. 送信時、現在のテキストが履歴に追加される
5. 50件を超えた場合、最も古い履歴を削除

#### 2.3.4 その他の機能

**クリアボタン:**
- テキストエリアの内容を全て削除
- 履歴の現在位置をリセット

**全セッション送信ボタン:**
- 現在のテキストを全セッションに一度に送信（ブロードキャスト）
- 内部的には`/broadcast`コマンドと同等の処理

### 2.4 入出力仕様

#### 2.4.1 入力

**ユーザー入力:**
- テキストエリアへのテキスト入力
- キーボードショートカット（Ctrl+数字、Ctrl+Enter、Enter、上下キー）
- ボタンクリック（バッファ取得、送信、全送信、クリア）

**APIリクエスト（新規追加）:**

```typescript
// バッファ取得リクエスト
GET /api/sessions/:id/buffer?fromPosition=<position>

// レスポンス
{
  sessionId: string;
  content: string;       // 差分のテキスト
  currentPosition: number; // 現在のバッファ位置
}
```

#### 2.4.2 出力

**テキスト送信:**
- セッションのPTYへの書き込み（既存のWebSocket `input`メッセージを使用）

**バッファ取得:**
- サーバーからセッションの出力バッファを取得
- テキストエリアに表示

### 2.5 状態管理

**クライアント側の状態:**

```typescript
interface ChatPaneState {
  // テキストエリアの内容
  currentText: string;

  // 入力履歴
  history: string[];        // 最大50件
  historyIndex: number;     // 現在の履歴位置（-1: 履歴なし）

  // バッファ取得位置（セッションIDごと）
  bufferPositions: {
    [sessionId: string]: number;
  };

  // テキストエリアの高さ（自動調整用）
  textareaHeight: number;
}
```

**永続化:**
- 入力履歴はlocalStorageに保存（キー: `wterm-chat-history`）
- バッファ取得位置はセッションストレージに保存（ページリロードでリセット）

### 2.6 エラーハンドリング

| エラーケース | 対処方法 |
|-------------|----------|
| 存在しないセッションへの送信 | 無視（何も起こらない） |
| 空のテキストエリアで送信 | 無視（何も起こらない） |
| バッファ取得失敗（セッション不在） | トースト通知「セッションXは存在しません」 |
| バッファ取得失敗（ネットワークエラー） | トースト通知「バッファ取得に失敗しました」 |
| テキストエリアが最大高さに達した | 縦スクロール表示 |

## 3. データ仕様

### 3.1 データモデル

**セッションバッファ位置管理:**

```typescript
// クライアント側
interface BufferPositionMap {
  [sessionId: string]: number; // バッファの文字位置
}

// 例:
// {
//   "session-1": 1500,
//   "session-2": 850,
//   "session-3": 2300
// }
```

**入力履歴:**

```typescript
// LocalStorageに保存
interface ChatHistory {
  items: string[];  // 最大50件
}

// 例:
// {
//   "items": [
//     "npm install",
//     "git status",
//     "echo 'Hello'",
//     ...
//   ]
// }
```

### 3.2 API仕様（新規追加）

#### 3.2.1 バッファ取得API

**エンドポイント:**
```
GET /api/sessions/:id/buffer
```

**クエリパラメータ:**
- `fromPosition` (optional): 取得開始位置（指定しない場合は全体を返す）

**レスポンス:**
```json
{
  "sessionId": "session-1",
  "content": "出力の差分テキスト...",
  "currentPosition": 1500
}
```

**ステータスコード:**
- `200 OK`: 成功
- `404 Not Found`: セッションが存在しない
- `500 Internal Server Error`: サーバーエラー

#### 3.2.2 既存APIの活用

**テキスト送信:**
- 既存のWebSocket `input`メッセージを使用
```typescript
{
  type: 'input',
  sessionId: string,
  data: string  // 送信するテキスト
}
```

**ブロードキャスト送信:**
- 既存の`/api/send` APIを使用
```typescript
POST /api/send
{
  "from": "browser",
  "to": "all",
  "message": string
}
```

### 3.3 データベーススキーマ

データベースは使用しない。全ての状態はメモリ（クライアント側）またはセッションストレージに保持。

## 4. UI/UX仕様

### 4.1 レイアウト

**全体構成:**

```
+-----------------------------------------------+
|  既存のヘッダー・タブバー                     |
+-----------------------------------------------+
|                                               |
|  ターミナル表示エリア                         |
|  (xterm.js)                                   |
|                                               |
|  ↕ 可変（チャット入力欄の高さに応じて調整）    |
+-----------------------------------------------+
|  [1][2][3][4][5][6][7][8][9]  [送信][全][×]  | ← ツールバー
+-----------------------------------------------+
|  メッセージを入力...                          | ← テキストエリア
|                                               |
|  ↕ 3行〜画面の30%（内容に応じて自動調整）     |
+-----------------------------------------------+
```

**レスポンシブ対応:**
- 画面幅が狭い場合（< 768px）:
  - バッファ取得ボタンを横スクロール可能にする
  - アクションボタンは常に表示

### 4.2 コンポーネント一覧

#### 4.2.1 チャット入力欄コンポーネント（新規）

**構成:**
- `ChatPane` (メインコンテナ)
  - `ChatToolbar` (ツールバー)
    - `BufferFetchButtons` (バッファ取得ボタン群)
    - `ActionButtons` (送信/クリアボタン群)
  - `ChatTextarea` (テキストエリア)

**実装ファイル:**
- `public/chat-pane.js` (新規作成)
- `public/style.css` (スタイル追加)

#### 4.2.2 既存コンポーネントの変更

**`public/app.js`:**
- チャット入力欄の初期化処理を追加
- ショートカットキーのイベントハンドラを追加

**`public/index.html`:**
- チャット入力欄のHTMLマークアップを追加

**`public/style.css`:**
- チャット入力欄のスタイルを追加
- ターミナル表示エリアの高さ調整（チャット入力欄分を考慮）

### 4.3 インタラクション

#### 4.3.1 キーボード操作

| キー | 動作 | 条件 |
|------|------|------|
| `Enter` | 改行を挿入 | テキストエリアにフォーカス |
| `Ctrl+Enter` | 現在のセッションに送信 | テキストエリアにフォーカス |
| `Ctrl+1`〜`Ctrl+9` | セッション1〜9に送信 | テキストエリアにフォーカス |
| `↑` | 前の履歴を表示 | テキストエリアにフォーカス |
| `↓` | 次の履歴を表示 | テキストエリアにフォーカス |
| `Esc` | テキストエリアのフォーカスを解除 | テキストエリアにフォーカス |

#### 4.3.2 マウス操作

| 操作 | 動作 |
|------|------|
| バッファ取得ボタン（1〜9）クリック | 対応するセッションのバッファを取得してテキストエリアに追加 |
| 送信ボタンクリック | 現在のセッションに送信 |
| 全送信ボタンクリック | 全セッションにブロードキャスト |
| クリアボタンクリック | テキストエリアをクリア |

#### 4.3.3 フィードバック

**送信時:**
- テキストエリアをクリア（視覚的フィードバック）
- アニメーションなどは不要（シンプルに）

**バッファ取得時:**
- テキストエリアに差分が追加される（視覚的フィードバック）
- 通知は表示しない

**エラー時:**
- トースト通知で短時間表示（3秒程度）
- 例: 「セッション5は存在しません」

### 4.4 レスポンシブ対応

**デスクトップ（幅 >= 768px）:**
- 全ボタンを横一列に表示

**モバイル/タブレット（幅 < 768px）:**
- バッファ取得ボタンを横スクロール可能なコンテナに配置
- アクションボタン（送信/クリア）は常に表示

### 4.5 アクセシビリティ

**キーボードナビゲーション:**
- `Tab`キーでボタン間を移動可能
- `Enter`または`Space`でボタンを押下

**スクリーンリーダー対応:**
- ボタンに適切な`aria-label`を設定
  - 例: `<button aria-label="セッション1のバッファを取得">1</button>`
- テキストエリアに`aria-label`を設定
  - 例: `<textarea aria-label="メッセージ入力欄"></textarea>`

**フォーカス管理:**
- 送信後、フォーカスはテキストエリアに残る
- バッファ取得後、フォーカスはテキストエリアに移動

## 5. 非機能要件

### 5.1 パフォーマンス

**レスポンスタイム:**
- テキスト送信: 即座に反映（< 100ms）
- バッファ取得: 1秒以内（通常のバッファサイズの場合）

**メモリ使用量:**
- 入力履歴: 最大50件 × 平均100文字 = 約5KB
- バッファ位置情報: 最大9セッション × 8バイト = 72バイト

**大量データへの対応:**
- バッファサイズが10,000行を超える場合、差分取得を推奨
- テキストエリアの最大高さ制限により、UIのパフォーマンスを保つ

### 5.2 セキュリティ

**XSS対策:**
- バッファ取得時のテキストは適切にエスケープ
- ユーザー入力はそのままターミナルに送るため、ターミナル側でのエスケープに依存

**CSRF対策:**
- 既存のwtermと同じセキュリティポリシーを適用
- 現状はローカルホスト専用のため、特別な対策は不要

### 5.3 可用性・信頼性

**エラー発生時の挙動:**
- バッファ取得失敗時も、他の機能は継続して使用可能
- ネットワークエラー時は、ユーザーに通知

**データの永続性:**
- 入力履歴はlocalStorageに保存（ブラウザを閉じても保持）
- バッファ取得位置はページリロードでリセット（意図的な設計）

## 6. 外部連携

### 6.1 外部API

使用しない。

### 6.2 他システム連携

**既存のwtermコンポーネントとの連携:**

- **WebSocketサーバー**: テキスト送信に使用
- **セッション管理**: バッファ取得、送信先の決定に使用
- **HTTP APIサーバー**: 新規バッファ取得APIを追加

## 7. テスト仕様

### 7.1 テスト観点

#### 7.1.1 正常系テスト

1. **テキスト送信**
   - [ ] Ctrl+Enterで現在のセッションに送信できる
   - [ ] Ctrl+1〜9で対応するセッションに送信できる
   - [ ] 送信ボタンで現在のセッションに送信できる
   - [ ] 全送信ボタンで全セッションに送信できる
   - [ ] 複数行のテキストを送信できる
   - [ ] 送信後、テキストエリアがクリアされる

2. **バッファ取得**
   - [ ] バッファ取得ボタンで対応するセッションのバッファを取得できる
   - [ ] 差分取得が正しく動作する（2回目以降は増分のみ）
   - [ ] テキストエリアの末尾に追加される
   - [ ] 差分がない場合、何も起こらない

3. **入力履歴**
   - [ ] 上キーで前の履歴を表示できる
   - [ ] 下キーで次の履歴を表示できる
   - [ ] 送信後、履歴に追加される
   - [ ] 最大50件を超えると古い履歴が削除される
   - [ ] ページリロード後も履歴が保持される

4. **UI動作**
   - [ ] テキストエリアの高さが内容に応じて自動調整される
   - [ ] 最大高さ（画面の30%）を超えるとスクロール表示される
   - [ ] クリアボタンでテキストエリアがクリアされる

#### 7.1.2 異常系テスト

1. **エラーケース**
   - [ ] 存在しないセッション番号へのショートカット送信が無視される
   - [ ] 空のテキストでの送信が無視される
   - [ ] バッファ取得失敗時にエラー通知が表示される
   - [ ] ネットワークエラー時に適切なエラーメッセージが表示される

2. **境界値テスト**
   - [ ] セッションが9個より多い場合、9個目までのみボタンが表示される
   - [ ] 大量のテキスト（10,000行以上）を送信できる
   - [ ] 入力履歴が50件ちょうどの場合、正しく動作する

#### 7.1.3 非機能テスト

1. **パフォーマンス**
   - [ ] 1,000行のバッファ取得が1秒以内に完了する
   - [ ] テキスト送信が100ms以内に完了する

2. **アクセシビリティ**
   - [ ] キーボードのみで全機能を操作できる
   - [ ] スクリーンリーダーで全ボタンのラベルが読み上げられる

### 7.2 テストケース

#### テストケース1: Ctrl+数字でのテキスト送信

**前提条件:**
- セッションが3つ存在する（session-1, session-2, session-3）
- テキストエリアに「Hello」と入力されている
- テキストエリアにフォーカスがある

**操作:**
1. `Ctrl+2`を押す

**期待結果:**
- session-2に「Hello」が送信される
- テキストエリアがクリアされる
- 履歴に「Hello」が追加される

#### テストケース2: バッファの差分取得

**前提条件:**
- session-1のバッファに「Line 1\nLine 2\n」（1000文字）が存在
- バッファを1回取得済み（position = 1000）
- その後、session-1に新しい出力「Line 3\n」（500文字）が追加

**操作:**
1. バッファ取得ボタン「1」をクリック

**期待結果:**
- テキストエリアに「Line 3\n」（差分のみ）が追加される
- position = 1500に更新される

#### テストケース3: 複数行テキストの送信

**前提条件:**
- session-1が存在
- テキストエリアに以下が入力されている:
  ```
  npm install
  npm start
  ```
- テキストエリアにフォーカスがある

**操作:**
1. `Ctrl+1`を押す

**期待結果:**
- session-1に「npm install\nnpm start\n」が一度に送信される
- session-1で2つのコマンドが順次実行される
- テキストエリアがクリアされる

#### テストケース4: 存在しないセッションへの送信

**前提条件:**
- セッションが2つのみ存在する（session-1, session-2）
- テキストエリアに「Test」と入力されている
- テキストエリアにフォーカスがある

**操作:**
1. `Ctrl+5`を押す

**期待結果:**
- 何も起こらない（送信されない）
- テキストエリアの内容は保持される
- エラーメッセージは表示されない

#### テストケース5: 入力履歴の呼び出し

**前提条件:**
- 履歴に「git status」「npm install」「echo test」が保存されている
- テキストエリアが空

**操作:**
1. `↑`を押す
2. `↑`を押す
3. `↓`を押す

**期待結果:**
1. テキストエリアに「echo test」が表示される
2. テキストエリアに「npm install」が表示される
3. テキストエリアに「echo test」が表示される

## 8. 備考

### 8.1 制約事項

- バッファ取得は最大9セッションまで対応（Ctrl+1〜9の制約）
- セッションが10個以上ある場合、10個目以降はバッファ取得ボタンが表示されない
- バッファ取得位置はページリロードでリセットされる（永続化しない）

### 8.2 今後の拡張予定

以下の機能は現バージョンでは実装しないが、将来的に検討可能：

1. **カスタマイズ可能なショートカット**
   - 設定ファイルでショートカットキーを変更可能に
   - Ctrl+数字以外のキーバインドもサポート

2. **バッファ取得位置の永続化**
   - ページリロード後も差分取得を継続できるように

3. **テキストエリアの高さを手動調整**
   - ドラッグでリサイズ可能に

4. **送信先のプレビュー**
   - Ctrl+数字を押したとき、送信先セッション名を一時表示

5. **マークダウンプレビュー**
   - テキストエリアにマークダウンを入力し、プレビュー表示

6. **ファイルアップロード**
   - ファイルをドラッグ&ドロップしてセッションに転送

### 8.3 課題・懸念事項

#### 8.3.1 実装上の課題

1. **バッファ位置の管理**
   - サーバー側でセッションの`outputBuffer`を文字列として保持しているため、差分取得には文字位置（インデックス）での管理が必要
   - 実装: `outputBuffer.substring(fromPosition)`で差分を取得

2. **テキストエリアの高さ調整**
   - 内容に応じて自動調整する際、ターミナル表示エリアの高さも連動して変更する必要がある
   - CSS FlexboxまたはGrid Layoutで実装

3. **履歴の永続化**
   - localStorageの容量制限（通常5MB）を考慮
   - 50件 × 平均100文字 = 約5KB なので問題なし

#### 8.3.2 UX上の懸念

1. **ショートカットキーの競合**
   - ブラウザやOSのショートカットと競合する可能性
   - 対策: テキストエリアにフォーカスがある時のみ有効にすることで、競合を最小化

2. **複数行テキストの送信**
   - 改行を含むテキストを一度に送ると、ターミナルで複数コマンドが連続実行される
   - これは意図的な動作だが、ユーザーが驚く可能性あり
   - 対策: ドキュメントに明記

3. **バッファ取得の遅延**
   - 大量の出力（10,000行以上）を持つセッションの場合、バッファ取得に時間がかかる可能性
   - 対策: ローディング表示を追加する（将来的な改善）

#### 8.3.3 セキュリティ上の懸念

1. **XSS（クロスサイトスクリプティング）**
   - バッファ取得時、ターミナル出力に悪意のあるスクリプトが含まれている可能性
   - 対策: テキストエリアはプレーンテキストとして扱うため、スクリプトは実行されない

2. **コマンドインジェクション**
   - ユーザーがテキストエリアに入力した内容は、そのままターミナルに送信される
   - これはwtermの設計上、意図的な動作
   - 対策: ローカルホスト専用のため、リスクは限定的

---

**最終更新**: 2026-01-20
**対象バージョン**: wterm 1.1.0
**作成者**: Claude Sonnet 4.5 (spec-writer skill)
