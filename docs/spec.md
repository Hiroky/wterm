# wterm - マルチセッションターミナル 仕様書

## 1. 概要

### 1.1 目的

複数のAIエージェント（Claude Code、GitHub Copilot CLI、Codexなど）がコンソールアプリケーションとして相互にやり取りできるマルチセッションターミナル環境を提供する。tmuxのような複数コンソールウィンドウ管理機能をブラウザベースで実現し、セッション間の入出力を簡単にやり取りできるようにする。

### 1.2 対象ユーザー

- AIエージェントツールを組み合わせて使う開発者
- 複数のターミナルセッションを同時に管理したい開発者
- 通常のターミナルとしても使用したい開発者

### 1.3 背景

現在、複数のAIエージェントCLIツール（Claude Code、GitHub Copilot CLIなど）が存在するが、それらを連携させて使うことは困難。wtermは、これらのエージェント間でメッセージをやり取りできる統一的なターミナル環境を提供し、AIエージェント同士の協調作業を可能にする。

## 2. 機能仕様

### 2.1 機能概要

wtermは以下の主要機能を提供する：

1. **マルチセッション管理**: 複数の独立したターミナルセッションを作成・管理
2. **セッション間通信**: 専用コマンドによるセッション間のメッセージ送受信
3. **ブラウザUI**: xterm.jsによるターミナル表示とレイアウト管理
4. **セッション永続化**: サーバープロセス実行中はセッションを維持
5. **ショートカット機能**: よく使うコマンドをワンクリックで実行

### 2.2 技術スタック

- **サーバー**: Bun（HTTPサーバー + WebSocketサーバー）
- **PTY管理**: node-pty（Windows対応の疑似端末）
- **クライアント**: xterm.js（ブラウザベースターミナルUI）
- **通信**: WebSocket（リアルタイム双方向通信）
- **対応OS**: Windows専用

### 2.3 アーキテクチャ

**Fat Server / Thin Client 構成**

```
┌─────────────────────────────────────────┐
│         ブラウザ（Thin Client）          │
│  ┌─────────────────────────────────┐   │
│  │        xterm.js UI              │   │
│  │  - ターミナル表示               │   │
│  │  - キー入力                     │   │
│  │  - レイアウト管理               │   │
│  └─────────────────────────────────┘   │
│              ↕ WebSocket                │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│       Bunサーバー（Fat Server）          │
│  ┌─────────────────────────────────┐   │
│  │   セッション管理                │   │
│  │  - セッション生成/削除          │   │
│  │  - 状態管理                     │   │
│  │  - 履歴バッファリング           │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │   PTYプロセス管理               │   │
│  │  - PowerShell起動               │   │
│  │  - 入出力処理                   │   │
│  │  - プロセス監視                 │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │   通信ルーティング              │   │
│  │  - セッション間メッセージ転送   │   │
│  │  - 受信履歴管理                 │   │
│  │  - API提供                      │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
          ↕ node-pty
┌─────────────────────────────────────────┐
│      PowerShellプロセス（複数）          │
│  - claude, copilot等のCLIツール実行    │
│  - wterm-sendコマンドでセッション間通信 │
└─────────────────────────────────────────┘
```

**重要な設計原則:**
- すべての状態（セッション、履歴、設定）はサーバー側に保持
- ブラウザはUIの表示と操作のみを担当
- ブラウザを閉じてもセッションは継続
- 再接続時に既存セッションに復帰可能

## 3. 詳細機能仕様

### 3.1 セッション管理

#### 3.1.1 セッション作成

**作成方法:**
1. UI上の「新規セッション」ボタン
2. ショートカットからの作成（後述）

**作成時の処理:**
1. サーバーがユニークなセッションIDを生成（例: `session-1`, `session-2`）
2. 以下の環境変数を設定してPowerShellプロセスを起動:
   - `WTERM_API_URL=http://localhost:3000`
   - `WTERM_SESSION_ID=<セッションID>`
   - `PATH=<既存PATH>;C:\wterm\bin` （wterm-sendコマンドのパス追加）
3. node-ptyで疑似端末を作成
4. WebSocketで出力をブラウザに送信

**同時セッション数:**
- 制限なし（ユーザーが好きなだけ作成可能）
- リソース管理はOSに委ねる

#### 3.1.2 セッション削除

**削除方法:**
- UI上の「セッション削除」メニュー（タブの×ボタンまたはコンテキストメニュー）

**削除時の処理:**
1. PTYプロセスを終了（SIGTERM送信）
2. セッションデータをサーバーから削除
3. ブラウザUIからタブを除去

#### 3.1.3 プロセス終了時の挙動

シェルプロセスが終了した場合（`exit`コマンドなど）:
- セッションは削除せずに保持
- ターミナルに「プロセスが終了しました」と表示
- 「再起動」ボタンを表示
- ユーザーがボタンをクリックすると同じセッションIDで新規プロセスを起動

**理由:** 通常のターミナルとしても使用するため、プロセス終了後も操作を継続できるようにする

#### 3.1.4 セッション永続性

**基本方針:**
- サーバープロセス（Bun）が実行中の限り、セッションを維持
- ブラウザを閉じてもサーバー側でPTYプロセスは継続実行
- `http://localhost:3000`に再アクセスすると既存セッションに再接続

**実装詳細:**
- WebSocket切断 ≠ セッション終了
- サーバー側で出力をバッファリング（一定サイズまで）
- 再接続時に履歴をブラウザに送信してxterm.jsに復元

**セッション終了のタイミング:**
- ユーザーが明示的に「セッション削除」を実行
- Bunサーバーを停止
- PTYプロセス終了後にユーザーが明示的に削除

### 3.2 セッション間通信

#### 3.2.1 通信の仕組み

**ハイブリッド方式**: ユーザーコマンド + 専用CLI

**A. ユーザーコマンド（手動実行）**
```powershell
PS> /send <target-session-id> <message>
PS> /broadcast <message>
PS> /list  # アクティブセッション一覧
```

**B. 専用CLIコマンド（AI/自動化用）**
```powershell
PS> wterm-send <target-session-id> <message>
PS> wterm-broadcast <message>
PS> wterm-list
```

**実装の違い:**
- `/send`: ターミナル内で解釈される内部コマンド（サーバーがフック）
- `wterm-send`: 実行可能スクリプト（Bunで作成）、環境変数から接続情報取得

#### 3.2.2 wterm-sendコマンドの実装

**配置場所:**
- `<プロジェクトルート>/bin/wterm-send.js`
- Bunで実行可能なスクリプトとして作成

**実装（疑似コード）:**
```javascript
#!/usr/bin/env bun
const apiUrl = process.env.WTERM_API_URL;
const fromSessionId = process.env.WTERM_SESSION_ID;
const targetSessionId = process.argv[2];
const message = process.argv.slice(3).join(' ');

if (!targetSessionId || !message) {
  console.error('使用法: wterm-send <session-id> <message>');
  process.exit(1);
}

try {
  const response = await fetch(`${apiUrl}/api/send`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      from: fromSessionId,
      to: targetSessionId,
      message: message
    })
  });

  if (!response.ok) {
    const error = await response.json();
    console.error(`エラー: ${error.message}`);
    process.exit(1);
  }
} catch (err) {
  console.error(`送信失敗: ${err.message}`);
  process.exit(1);
}
```

**wterm-broadcastとwterm-listも同様の実装**

#### 3.2.3 メッセージ受信の処理

**受信方法:**
- サーバーが対象セッションのPTYに標準入力として書き込み
- 自動的にEnterキーを送信（コマンド実行）

**動作例:**
```powershell
# セッション1
PS> wterm-send session-2 "このコードをレビューしてください: function foo() { ... }"

# セッション2（自動的に入力される）
PS> copilot  # すでにCopilot CLI実行中
このコードをレビューしてください: function foo() { ... }
> # Copilotが上記メッセージを受け取って処理
```

**受信履歴:**
- サーバー側で全受信メッセージを記録
- ブラウザUIの履歴パネルで確認可能（後述）

#### 3.2.4 エラーハンドリング

**送信先セッションが存在しない場合:**
```powershell
PS> wterm-send invalid-session "test"
エラー: セッション 'invalid-session' が見つかりません
利用可能なセッション: session-1, session-2, session-3
```
- エラーメッセージを表示
- 利用可能なセッション一覧を表示

### 3.3 ショートカット機能

#### 3.3.1 ショートカットの定義

ショートカットは、よく使うコマンドをワンクリックで実行する機能。

**設定ファイル: `config.json`**
```json
{
  "port": 3000,
  "shortcuts": [
    {
      "id": "claude",
      "name": "Claude Code",
      "command": "claude",
      "icon": "🤖"
    },
    {
      "id": "copilot",
      "name": "Copilot CLI",
      "command": "gh copilot",
      "icon": "🚁"
    },
    {
      "id": "powershell",
      "name": "PowerShell",
      "command": "",
      "icon": "💻"
    }
  ],
  "uiLayout": {
    "showSidebar": true,
    "sidebarPosition": "left"
  }
}
```

**フィールド説明:**
- `id`: 一意の識別子
- `name`: UIに表示する名前
- `command`: 実行するコマンド（空の場合はPowerShellのみ起動）
- `icon`: 表示アイコン（絵文字または画像パス）

#### 3.3.2 ショートカットの管理

**設定方法: 2つの方法を提供**

**A. 設定ファイル編集**
- `config.json`を直接編集
- サーバー再起動で反映

**B. UI上での編集**
- ブラウザの設定画面で追加・編集・削除
- 保存ボタンで`config.json`に書き込み

**ショートカットの使用:**
1. UI上のショートカットボタンをクリック
2. 新しいセッションが作成される
3. PowerShellが起動し、自動的に登録コマンドが実行される

**実装例:**
```javascript
// ショートカット「Claude Code」をクリック
// → セッション作成
// → PowerShell起動
// → 自動的に "claude\n" を標準入力に送信
```

### 3.4 ブラウザUI

#### 3.4.1 画面レイアウト

**基本構成（カスタマイズ可能）:**

```
┌────────────────────────────────────────────────────┐
│ ヘッダー                                            │
│ [wterm] [+新規] [ショートカット▼] [レイアウト切替] │
├─────┬──────────────────────────────────────────────┤
│セッ │ [Tab: session-1] [Tab: session-2] [+]        │
│ショ ├──────────────────────────────────────────────┤
│ン一 │                                              │
│覧   │          ターミナル表示エリア                 │
│     │          (xterm.js)                          │
│ [1] │                                              │
│ [2] │                                              │
│ [3] │                                              │
│     ├──────────────────────────────────────────────┤
│     │ 📨 受信履歴パネル（折りたたみ可能）          │
│     │ [10:15] session-1 → session-2: メッセージ... │
├─────┴──────────────────────────────────────────────┤
│ ステータスバー: 接続状態, アクティブセッション数    │
└────────────────────────────────────────────────────┘
```

**カスタマイズ可能な要素:**
- サイドバー（セッション一覧）の表示/非表示
- 受信履歴パネルの表示/非表示
- サイドバーの位置（左/右）
- パネルのリサイズ

**設定の保存:**
- `config.json`の`uiLayout`セクションに保存
- ブラウザのlocalStorageにも保存（優先度: localStorage > config.json）

#### 3.4.2 ビューモード

**2つのビューモードを切り替え可能:**

**A. タブビュー（デフォルト）**
```
[Tab: session-1] [Tab: session-2] [Tab: session-3] [+]
┌────────────────────────────────────────────┐
│                                            │
│         session-1のターミナル表示          │
│                                            │
└────────────────────────────────────────────┘
```
- 1つのセッションのみ表示
- タブクリックで切り替え

**B. 分割ビュー**
```
┌─────────────────────┬─────────────────────┐
│ session-1           │ session-2           │
│                     │                     │
│                     │                     │
├─────────────────────┴─────────────────────┤
│ session-3                                 │
│                                           │
└───────────────────────────────────────────┘
```
- 複数セッションを同時表示
- 縦分割・横分割を組み合わせ可能

**切り替え方法:**
- ヘッダーの「レイアウト切替」ボタン
- ショートカットキー: `Ctrl+Shift+L`

#### 3.4.3 分割ビューの操作

**分割の作成方法: コンテキストメニュー**

1. セッションタブを右クリック
2. メニュー表示:
   - 「縦に分割」
   - 「横に分割」
   - 「分割解除」
   - 「セッション削除」
3. 選択すると画面が分割され、ターミナルが配置される

**分割のリサイズ:**
- 分割線をドラッグしてサイズ調整

**分割の解除:**
- 分割されたペインのコンテキストメニューから「分割解除」
- または「レイアウト切替」でタブビューに戻る

#### 3.4.4 セッション一覧サイドバー

**表示内容:**
```
セッション一覧
├─ session-1 [実行中] 🟢
│   PowerShell
├─ session-2 [実行中] 🟢
│   claude
└─ session-3 [終了] 🔴
    exit code: 0
    [再起動]
```

**機能:**
- セッションをクリックで選択（アクティブ化）
- 右クリックでコンテキストメニュー（削除、分割など）
- 実行状態の表示（実行中/終了）
- プロセス終了時に再起動ボタン表示

#### 3.4.5 受信履歴パネル

**表示内容:**
```
📨 受信履歴
[10:15:32] session-1 → session-2
  このコードをレビューしてください: function foo() { ... }
[10:16:45] session-2 → broadcast
  ビルドが完了しました
[10:18:20] session-3 → session-1
  エラーが発生しました: ...
```

**機能:**
- 時刻、送信元、送信先、メッセージ内容を表示
- 最新50件を表示（設定で変更可能）
- クリックで詳細表示（長いメッセージの場合）
- フィルター機能（特定セッションのみ表示）
- パネルの折りたたみ/展開

### 3.5 設定管理

#### 3.5.1 設定ファイル

**ファイルパス:** `<プロジェクトルート>/config.json`

**デフォルト設定:**
```json
{
  "port": 3000,
  "maxHistorySize": 50,
  "bufferSize": 10000,
  "shortcuts": [
    {
      "id": "powershell",
      "name": "PowerShell",
      "command": "",
      "icon": "💻"
    }
  ],
  "uiLayout": {
    "showSidebar": true,
    "sidebarPosition": "left"
  }
}
```

**設定項目:**
- `port`: サーバーのポート番号（デフォルト: 3000、変更可能）
- `maxHistorySize`: 受信履歴の最大保存件数
- `bufferSize`: 出力バッファのサイズ（文字数）
- `shortcuts`: ショートカット定義の配列
- `uiLayout`: UI表示設定

#### 3.5.2 設定の読み込み

**起動時の処理:**
1. `config.json`が存在するか確認
2. 存在しない場合はデフォルト設定で作成
3. 存在する場合は読み込み
4. 不正なJSONの場合はエラー表示して終了

**ポート番号が使用中の場合:**
- エラーメッセージを表示して終了
- 別のポートを試さない（明示的な設定を尊重）

## 4. データ仕様

### 4.1 データモデル

#### 4.1.1 Session（セッション）

```typescript
interface Session {
  id: string;                    // セッションID（例: "session-1"）
  pid: number;                   // PTYプロセスID
  pty: IPty;                     // node-ptyインスタンス
  status: 'running' | 'exited';  // 実行状態
  exitCode?: number;             // 終了コード（exitedの場合）
  createdAt: Date;               // 作成日時
  command: string;               // 起動コマンド（ショートカット用）
  outputBuffer: string[];        // 出力バッファ（最大bufferSize）
  connectedClients: Set<string>; // 接続中のWebSocketクライアントID
}
```

#### 4.1.2 Message（セッション間メッセージ）

```typescript
interface Message {
  id: string;            // メッセージID
  from: string;          // 送信元セッションID
  to: string | 'all';    // 送信先セッションID（'all'はブロードキャスト）
  content: string;       // メッセージ内容
  timestamp: Date;       // 送信日時
}
```

#### 4.1.3 Shortcut（ショートカット）

```typescript
interface Shortcut {
  id: string;      // 一意のID
  name: string;    // 表示名
  command: string; // 実行コマンド（空文字列の場合はシェルのみ）
  icon: string;    // アイコン（絵文字または画像パス）
}
```

### 4.2 API仕様

#### 4.2.1 HTTPエンドポイント

**GET /**
- 説明: メインHTMLページを返す
- レスポンス: `text/html`

**GET /config**
- 説明: 現在の設定を取得
- レスポンス:
```json
{
  "port": 3000,
  "shortcuts": [...],
  "uiLayout": {...}
}
```

**POST /config**
- 説明: 設定を更新（UI編集用）
- リクエストボディ: `config.json`と同じ形式
- レスポンス:
```json
{
  "success": true
}
```

**POST /api/send**
- 説明: セッション間メッセージ送信（wterm-sendから呼ばれる）
- リクエストボディ:
```json
{
  "from": "session-1",
  "to": "session-2",
  "message": "メッセージ内容"
}
```
- レスポンス:
```json
{
  "success": true,
  "messageId": "msg-123"
}
```
- エラーレスポンス（送信先が存在しない）:
```json
{
  "success": false,
  "message": "セッション 'session-2' が見つかりません",
  "availableSessions": ["session-1", "session-3"]
}
```

**GET /api/sessions**
- 説明: アクティブセッション一覧を取得
- レスポンス:
```json
{
  "sessions": [
    {
      "id": "session-1",
      "status": "running",
      "createdAt": "2026-01-16T01:00:00Z",
      "command": "claude"
    }
  ]
}
```

**POST /api/sessions**
- 説明: 新しいセッションを作成
- リクエストボディ:
```json
{
  "command": "claude"  // オプション、空の場合はPowerShellのみ
}
```
- レスポンス:
```json
{
  "sessionId": "session-4"
}
```

**DELETE /api/sessions/:id**
- 説明: セッションを削除
- レスポンス:
```json
{
  "success": true
}
```

**POST /api/sessions/:id/restart**
- 説明: 終了したセッションを再起動
- レスポンス:
```json
{
  "success": true
}
```

**GET /api/history**
- 説明: 受信履歴を取得
- クエリパラメータ:
  - `limit`: 取得件数（デフォルト: 50）
  - `sessionId`: フィルター用セッションID（オプション）
- レスポンス:
```json
{
  "messages": [
    {
      "id": "msg-1",
      "from": "session-1",
      "to": "session-2",
      "content": "メッセージ",
      "timestamp": "2026-01-16T01:15:32Z"
    }
  ]
}
```

#### 4.2.2 WebSocketプロトコル

**接続: ws://localhost:3000**

**クライアント → サーバー**

```json
// セッション接続
{
  "type": "attach",
  "sessionId": "session-1"
}

// 入力送信
{
  "type": "input",
  "sessionId": "session-1",
  "data": "ls\n"
}

// リサイズ通知
{
  "type": "resize",
  "sessionId": "session-1",
  "cols": 80,
  "rows": 24
}
```

**サーバー → クライアント**

```json
// 出力データ
{
  "type": "output",
  "sessionId": "session-1",
  "data": "C:\\Users\\...>"
}

// セッション一覧更新
{
  "type": "sessions",
  "sessions": [...]
}

// メッセージ受信通知
{
  "type": "message",
  "message": {
    "id": "msg-1",
    "from": "session-1",
    "to": "session-2",
    "content": "...",
    "timestamp": "..."
  }
}

// セッション終了通知
{
  "type": "exit",
  "sessionId": "session-1",
  "exitCode": 0
}

// エラー通知
{
  "type": "error",
  "message": "エラー内容"
}
```

### 4.3 データの永続化

**永続化される設定:**
- `config.json`: ポート番号、ショートカット、UIレイアウト設定

**メモリ内保持（サーバー再起動で消失）:**
- セッション状態
- 出力バッファ
- 受信履歴

**注意:** この初期バージョンでは、セッション状態の永続化（ディスク保存）は実装しない。サーバー再起動時には全セッションが失われる。

## 5. UI/UX仕様

### 5.1 コンポーネント一覧

#### 5.1.1 ヘッダー

- アプリケーションタイトル（wterm）
- 新規セッションボタン
- ショートカットドロップダウン
- レイアウト切替ボタン
- 設定ボタン

#### 5.1.2 サイドバー（セッション一覧）

- セッションリスト
  - セッションID
  - 実行状態インジケーター
  - コマンド名
  - 再起動ボタン（終了時のみ）
- 折りたたみボタン

#### 5.1.3 ターミナル表示エリア

- xterm.jsコンポーネント
- タブバー（タブビュー時）
- 分割ペイン（分割ビュー時）

#### 5.1.4 受信履歴パネル

- メッセージリスト
  - タイムスタンプ
  - 送信元 → 送信先
  - メッセージ内容
- フィルター入力欄
- 折りたたみボタン

#### 5.1.5 ステータスバー

- WebSocket接続状態
- アクティブセッション数
- 現在選択中のセッションID

#### 5.1.6 コンテキストメニュー

表示タイミング: タブまたはセッション一覧を右クリック

メニュー項目:
- 縦に分割
- 横に分割
- 分割解除（分割ビュー時のみ）
- セッション再起動（終了時のみ）
- セッション削除

#### 5.1.7 設定ダイアログ

表示内容:
- ポート番号設定
- ショートカット管理（追加・編集・削除）
- UIレイアウト設定
  - サイドバー表示
  - 履歴パネル表示
  - サイドバー位置
- 保存ボタン / キャンセルボタン

### 5.2 インタラクション

#### 5.2.1 セッション作成フロー

1. ユーザーが「新規セッション」ボタンをクリック
2. サーバーにPOSTリクエスト（`/api/sessions`）
3. サーバーがセッションを作成してIDを返す
4. 新しいタブが作成され、xterm.jsが初期化される
5. WebSocketで`attach`メッセージを送信
6. サーバーがPTY出力をWebSocketで送信開始

#### 5.2.2 ショートカット実行フロー

1. ユーザーがショートカットボタンをクリック
2. セッション作成APIを呼び出し（`command`付き）
3. サーバーがPowerShellを起動し、自動的にコマンドを実行
4. UIに新しいタブが表示され、実行結果が表示される

#### 5.2.3 メッセージ送信フロー

**パターンA: ユーザーが手動で送信**
1. ターミナルで `/send session-2 こんにちは` と入力
2. サーバーがコマンドを検出
3. session-2のPTYに「こんにちは\n」を書き込み
4. 受信履歴パネルに記録

**パターンB: AIが自動送信**
1. Claude Codeが `wterm-send session-2 こんにちは` を実行
2. wterm-sendがHTTP APIを呼び出し
3. サーバーがsession-2にメッセージを転送
4. 受信履歴パネルに記録

#### 5.2.4 画面分割フロー

1. タブを右クリック
2. 「縦に分割」を選択
3. 画面が2つのペインに分割される
4. 選択したセッションが新しいペインに表示される
5. 他のセッションを選択して別ペインに表示可能

#### 5.2.5 WebSocket再接続フロー

1. 接続が切れたことを検出
2. ステータスバーに「再接続中...」と表示
3. 5秒ごとに再接続を試行（最大10回）
4. 再接続成功時:
   - 既存セッション一覧を取得
   - 各セッションに再接続
   - バッファされた出力を復元
5. 再接続失敗時:
   - エラーメッセージを表示
   - 「再接続」ボタンを表示

### 5.3 レスポンシブ対応

**対応範囲:**
- デスクトップのみ対応（Windows想定）
- 最小画面幅: 1024px
- モバイル/タブレット対応は将来の拡張として除外

### 5.4 アクセシビリティ

**最低限の対応:**
- キーボード操作対応
  - Tab / Shift+Tab: フォーカス移動
  - Ctrl+Shift+T: 新規セッション
  - Ctrl+Shift+W: セッション削除
  - Ctrl+Shift+L: レイアウト切替
- ARIA属性の設定（ボタン、リスト）

**フルアクセシビリティ対応は将来の拡張として除外**

## 6. 非機能要件

### 6.1 パフォーマンス

**応答時間:**
- WebSocket接続確立: 1秒以内
- キー入力のレイテンシ: 50ms以内
- 画面分割の切り替え: 100ms以内

**大量データ対応:**
- 出力バッファサイズ: 10,000文字（設定可能）
- 超過した場合は古い出力を削除（FIFO）
- xterm.jsのスクロールバックバッファ: 1,000行

**同時セッション:**
- 10セッションまでは快適に動作することを目標
- それ以上は性能劣化を許容

### 6.2 セキュリティ

**基本方針:**
- localhostからのアクセスのみ許可
- 認証機能なし（ローカル環境のみ想定）
- HTTPS対応なし

**将来の拡張:**
- リモートアクセス対応時に認証・暗号化を追加
- 初期バージョンではセキュリティは最小限

### 6.3 可用性・信頼性

**ダウンタイム:**
- サーバー再起動時のみ停止（計画的）
- 自動復旧機能なし

**エラー処理:**
- PTYプロセスクラッシュ: セッション終了として扱い、再起動可能にする
- WebSocket切断: 自動再接続を試みる
- 不正なAPIリクエスト: エラーレスポンスを返す

**ログ出力:**
- サーバーコンソールに基本的なログ出力
- エラー発生時にスタックトレースを出力
- ログファイル保存は将来の拡張

### 6.4 保守性

**コード構成:**
- TypeScriptで型安全性を確保
- モジュール分割（セッション管理、通信、UI）
- コメントによる説明（複雑なロジックのみ）

**デバッグ:**
- 開発モードでの詳細ログ出力
- ブラウザのDevToolsで通信内容を確認可能

## 7. 外部連携

### 7.1 外部ツール

**連携対象のCLIツール:**
- Claude Code（`claude`コマンド）
- GitHub Copilot CLI（`gh copilot`コマンド）
- Codex（想定）
- その他任意のコマンドラインツール

**連携方法:**
- 環境変数でAPI接続情報を提供
- `wterm-send`コマンドでメッセージ送信
- 標準入出力経由で通信

**制約:**
- 各ツールが`wterm-send`を呼び出せる必要がある
- PowerShell上で動作する必要がある

### 7.2 サードパーティライブラリ

**必須ライブラリ:**
- **node-pty**: PTY（疑似端末）管理
- **xterm.js**: ブラウザターミナルUI
- **xterm-addon-fit**: xterm.jsのリサイズアドオン
- **xterm-addon-web-links**: URL自動リンク化

**オプションライブラリ:**
- UIフレームワーク（React/Vue/Svelte等）: 検討中、必須ではない
- スタイリング（Tailwind/Bootstrap等）: 検討中

## 8. テスト仕様

### 8.1 テスト観点

**機能テスト:**
- セッション作成・削除が正しく動作するか
- セッション間メッセージ送信が正しく転送されるか
- wterm-sendコマンドがメッセージを送信できるか
- ショートカットが正しくコマンドを実行するか
- プロセス終了時に再起動ボタンが表示されるか
- WebSocket再接続が正しく動作するか

**異常系テスト:**
- 存在しないセッションへの送信
- 不正なJSON形式のAPIリクエスト
- ポート使用中の場合の起動
- PTYプロセスクラッシュ時の挙動
- WebSocket切断時の再接続

**パフォーマンステスト:**
- 10セッション同時起動時の応答性
- 大量出力時のバッファ動作
- 長時間実行時のメモリリーク確認

### 8.2 テストケース例

#### 8.2.1 セッション間通信のテスト

**正常系:**
1. セッション1とセッション2を作成
2. セッション1で `wterm-send session-2 テストメッセージ` を実行
3. セッション2に「テストメッセージ」が表示されることを確認
4. 受信履歴パネルに記録されることを確認

**異常系:**
1. セッション1で `wterm-send invalid-session メッセージ` を実行
2. エラーメッセージ「セッション 'invalid-session' が見つかりません」が表示されることを確認
3. 利用可能なセッション一覧が表示されることを確認

#### 8.2.2 セッション永続性のテスト

1. セッション1を作成してコマンドを実行
2. ブラウザを閉じる
3. 再度 `http://localhost:3000` にアクセス
4. セッション1が一覧に表示されることを確認
5. セッション1に接続すると、以前の出力履歴が表示されることを確認

#### 8.2.3 ショートカットのテスト

1. 設定で「Test Command」ショートカットを作成（コマンド: `echo "Hello"`）
2. ショートカットボタンをクリック
3. 新しいセッションが作成されることを確認
4. ターミナルに「Hello」が表示されることを確認

### 8.3 テスト方法

**手動テスト:**
- 初期バージョンは手動テスト中心
- テストシナリオに従って操作を確認

**自動テスト（将来の拡張）:**
- APIエンドポイントの単体テスト
- WebSocketプロトコルのテスト
- E2Eテスト（Playwright等）

## 9. 実装の優先順位とタスク分割

### 9.1 フェーズ1: 基本機能（MVP）

**タスク:**
1. プロジェクトセットアップ
   - Bun環境構築
   - TypeScript設定
   - 基本的なディレクトリ構成

2. サーバー実装
   - HTTPサーバー起動
   - WebSocketサーバー実装
   - 設定ファイル読み込み

3. PTY管理
   - node-ptyでPowerShell起動
   - 標準入出力の処理
   - プロセス終了の検出

4. セッション管理
   - セッション作成・削除
   - セッション一覧管理
   - 出力バッファリング

5. クライアントUI（基本）
   - HTMLページ作成
   - xterm.js統合
   - WebSocket接続

6. タブビュー実装
   - タブ切り替え
   - 新規セッション作成UI
   - セッション削除UI

7. 起動とブラウザ自動起動
   - サーバー起動スクリプト
   - ブラウザ自動起動機能

**ゴール:** 複数のターミナルをタブで切り替えて使える状態

### 9.2 フェーズ2: セッション間通信

**タスク:**
1. wterm-sendコマンド実装
   - Bunスクリプト作成
   - HTTP API実装（`/api/send`）
   - 環境変数の設定

2. メッセージ受信処理
   - PTYへの入力書き込み
   - 受信履歴の記録

3. 受信履歴パネル実装
   - UI作成
   - WebSocketでリアルタイム更新
   - フィルター機能

4. wterm-listコマンド実装
   - セッション一覧API
   - コマンドスクリプト

5. wterm-broadcastコマンド実装
   - 全セッションへのメッセージ送信

**ゴール:** セッション間でメッセージをやり取りできる状態

### 9.3 フェーズ3: 分割ビューとショートカット

**タスク:**
1. 分割ビュー実装
   - 分割レイアウトコンポーネント
   - ペインのリサイズ
   - レイアウト切り替え

2. コンテキストメニュー実装
   - 右クリックメニュー
   - 縦/横分割機能

3. ショートカット機能
   - 設定ファイルの拡張
   - ショートカットUI
   - コマンド自動実行

4. 設定ダイアログ
   - UI作成
   - ショートカット追加・編集・削除
   - 設定保存機能

**ゴール:** すべてのMVP機能が揃った状態

### 9.4 フェーズ4: 安定化とエラーハンドリング

**タスク:**
1. エラーハンドリング強化
   - 各エラーケースの処理
   - ユーザーへの通知

2. WebSocket再接続
   - 自動再接続ロジック
   - 接続状態の表示

3. プロセス終了後の再起動
   - 再起動ボタン
   - セッション状態管理

4. UIの調整とバグフィックス
   - 各種UIの改善
   - バグ修正

5. テストと検証
   - 手動テスト実施
   - バグフィックス

**ゴール:** 安定して使える製品品質

## 10. 備考

### 10.1 制約事項

**技術的制約:**
- Windows専用（node-ptyのWindows対応に依存）
- ローカルホストのみ（認証なし）
- デスクトップブラウザのみ対応

**機能的制約:**
- セッション状態の永続化なし（サーバー再起動で消失）
- ログファイル保存なし
- モバイル対応なし

### 10.2 今後の拡張予定

**フェーズ5以降（優先度低）:**
- セッション状態の保存・復元（ディスク永続化）
- ログファイル出力機能
- 複数Bunサーバーの管理
- リモートアクセス対応（認証・暗号化）
- プリセット機能（複数セッションの一括起動）
- テーマ・カラースキーム変更
- 自動テストの実装
- macOS/Linux対応

### 10.3 課題・懸念事項

**パフォーマンス:**
- セッション数が増えた場合のメモリ使用量
- 大量出力時のバッファ管理
- → 実際に使いながら調整が必要

**セキュリティ:**
- 現時点では認証なしでローカルホストのみ
- 将来的にリモートアクセスする場合は認証必須
- → フェーズ5以降で対応

**互換性:**
- AIエージェントツールが環境変数を正しく継承するか
- `wterm-send`コマンドがPATHから実行できるか
- → 実装後に各ツールで動作確認が必要

**ユーザビリティ:**
- UIが直感的か（特に分割ビュー操作）
- → 実際に使ってフィードバックを集める

### 10.4 参考資料

**類似プロジェクト:**
- tmux: ターミナルマルチプレクサ
- screen: 仮想端末管理
- terminus: Electron製ターミナル
- hyper: Electron製ターミナル

**技術ドキュメント:**
- node-pty: https://github.com/microsoft/node-pty
- xterm.js: https://xtermjs.org/
- Bun: https://bun.sh/
- WebSocket API: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket

---

**仕様書バージョン:** 1.0
**作成日:** 2026-01-16
**最終更新:** 2026-01-16
