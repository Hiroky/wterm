#!/bin/bash
# wterm-send - セッション間メッセージ送信コマンド（WSL版）

WTERM_API_URL="${WTERM_API_URL}"
WTERM_SESSION_ID="${WTERM_SESSION_ID}"

if [ -z "$WTERM_API_URL" ]; then
  echo "エラー: WTERM_API_URL 環境変数が設定されていません" >&2
  echo "このコマンドはwterm内のセッションから実行してください" >&2
  exit 1
fi

if [ -z "$WTERM_SESSION_ID" ]; then
  echo "エラー: WTERM_SESSION_ID 環境変数が設定されていません" >&2
  echo "このコマンドはwterm内のセッションから実行してください" >&2
  exit 1
fi

# オプション解析
WAIT_FOR_RESPONSE=true
while [[ $# -gt 0 ]]; do
  case $1 in
    --no-wait|-n)
      WAIT_FOR_RESPONSE=false
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ $# -lt 2 ]; then
  echo "使用法: wterm-send [--no-wait|-n] <session-id> <message>" >&2
  echo "" >&2
  echo "オプション:" >&2
  echo "  --no-wait, -n    レスポンスを待たずに終了（投げっぱなしモード）" >&2
  echo "" >&2
  echo "例:" >&2
  echo "  wterm-send session-2 こんにちは" >&2
  echo "  wterm-send --no-wait session-2 ビルド開始" >&2
  exit 1
fi

TARGET_SESSION_ID="$1"
shift
MESSAGE="$*"

# WSL2対応: localhostをWindowsホストのIPアドレスに置き換え
if [[ "$WTERM_API_URL" == *"localhost"* ]]; then
  # ip routeコマンドでWindowsホストのIPアドレスを取得（推奨）
  if command -v ip &> /dev/null; then
    WINDOWS_HOST=$(ip route show default | awk '{print $3}' | head -1)
  fi
  # フォールバック: /etc/resolv.confから取得
  if [ -z "$WINDOWS_HOST" ] && [ -f /etc/resolv.conf ]; then
    WINDOWS_HOST=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}' | head -1)
  fi
  if [ -n "$WINDOWS_HOST" ]; then
    WTERM_API_URL="${WTERM_API_URL/localhost/$WINDOWS_HOST}"
  fi
fi

# APIリクエストを送信
RESPONSE=$(curl -s -w "\n%{http_code}" \
  -X POST \
  -H "Content-Type: application/json" \
  -d "{\"from\":\"$WTERM_SESSION_ID\",\"to\":\"$TARGET_SESSION_ID\",\"message\":\"$MESSAGE\",\"waitForResponse\":$WAIT_FOR_RESPONSE}" \
  "$WTERM_API_URL/api/send")

# HTTPステータスコードを取得
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if [ "$HTTP_CODE" != "200" ]; then
  echo "エラー: HTTPリクエスト失敗 (HTTP $HTTP_CODE)" >&2
  exit 1
fi

# JSONレスポンスを解析
SUCCESS=$(echo "$BODY" | grep -o '"success":[^,}]*' | cut -d':' -f2 | tr -d ' ')

if [ "$SUCCESS" != "true" ]; then
  ERROR_MSG=$(echo "$BODY" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
  echo "エラー: ${ERROR_MSG:-送信に失敗しました}" >&2

  # 利用可能なセッション一覧を表示
  AVAILABLE=$(echo "$BODY" | grep -o '"availableSessions":\[[^]]*\]' | sed 's/"availableSessions":\[//;s/\]//;s/"//g')
  if [ -n "$AVAILABLE" ]; then
    echo "利用可能なセッション: $AVAILABLE" >&2
  fi
  exit 1
fi

# 投げっぱなしモードの場合はここで終了
if [ "$WAIT_FOR_RESPONSE" = "false" ]; then
  echo "メッセージを送信しました"
  exit 0
fi

# レスポンス出力を整形して表示
OUTPUT=$(echo "$BODY" | grep -o '"output":"[^"]*"' | cut -d'"' -f4 | sed 's/\\r\\n/\n/g;s/\\n/\n/g;s/\\t/\t/g')

if [ -n "$OUTPUT" ]; then
  # ANSIエスケープシーケンスを除去
  CLEAN_OUTPUT=$(echo -e "$OUTPUT" | sed -r 's/\x1b\[[0-9]+;[0-9]+H/\n/g;s/\x1b\[[^m]*m//g;s/\x1b\[[0-9;?]*[A-Za-z]//g;s/\x1b\][^\x07]*\x07//g;s/\x1b[=>]//g')

  # PowerShellプロンプト行を除去
  FILTERED_OUTPUT=$(echo "$CLEAN_OUTPUT" | grep -v "^PS.*>.*$" | sed '/^$/d')

  if [ -n "$FILTERED_OUTPUT" ]; then
    echo "$FILTERED_OUTPUT"
  fi
fi
