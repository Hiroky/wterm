#!/bin/bash
# wterm-list - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰ï¼ˆWSLç‰ˆï¼‰

WTERM_API_URL="${WTERM_API_URL}"
WTERM_SESSION_ID="${WTERM_SESSION_ID}"

if [ -z "$WTERM_API_URL" ]; then
  echo "ã‚¨ãƒ©ãƒ¼: WTERM_API_URL ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
  echo "ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯wtermå†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
  exit 1
fi

# WSL2å¯¾å¿œ: localhostã‚’Windowsãƒ›ã‚¹ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆ
if [[ "$WTERM_API_URL" == *"localhost"* ]]; then
  # ip routeã‚³ãƒãƒ³ãƒ‰ã§Windowsãƒ›ã‚¹ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆæ¨å¥¨ï¼‰
  if command -v ip &> /dev/null; then
    WINDOWS_HOST=$(ip route show default | awk '{print $3}' | head -1)
  fi
  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: /etc/resolv.confã‹ã‚‰å–å¾—
  if [ -z "$WINDOWS_HOST" ] && [ -f /etc/resolv.conf ]; then
    WINDOWS_HOST=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}' | head -1)
  fi
  if [ -n "$WINDOWS_HOST" ]; then
    WTERM_API_URL="${WTERM_API_URL/localhost/$WINDOWS_HOST}"
  fi
fi

# APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
RESPONSE=$(curl -s -w "\n%{http_code}" \
  -X GET \
  "$WTERM_API_URL/api/sessions")

# HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if [ "$HTTP_CODE" != "200" ]; then
  echo "ã‚¨ãƒ©ãƒ¼: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•— (HTTP $HTTP_CODE)" >&2
  exit 1
fi

echo ""
echo "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
# jqãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ã‚ˆã‚Šè©³ç´°ãªè¡¨ç¤ºãŒå¯èƒ½
if command -v jq &> /dev/null; then
  echo "$BODY" | jq -r '.sessions[] |
    "\(if .status == "running" then "ğŸŸ¢" else "ğŸ”´" end) \(.id)\(if .id == env.WTERM_SESSION_ID then " (ç¾åœ¨)" else "" end)\n   ã‚³ãƒãƒ³ãƒ‰: \(.command // "PowerShell")\(if .exitCode then " [exit: \(.exitCode)]" else "" end)\n"'
else
  # jqãŒãªã„å ´åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¤º
  echo "$BODY" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | while read -r session_id; do
    if [ "$session_id" = "$WTERM_SESSION_ID" ]; then
      echo "ğŸŸ¢ $session_id (ç¾åœ¨)"
    else
      echo "ğŸŸ¢ $session_id"
    fi
    echo ""
  done
fi

echo ""
